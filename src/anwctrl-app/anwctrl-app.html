<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker-light.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">

<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../anw-single/anw-single.html">
<link rel="import" href="../anw-notifications/anw-notifications.html">


<dom-module id="anwctrl-app">
    <template>
        <style>
            :host {
                display: block;
            }

            .main-content {
                max-width: 460px;
                width: 100%;
            }

            .loading {
                height: 100%;
            }

            .full-width {
                width: 100%;
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: #fff;
                --paper-tab-ink: #fff;
                --paper-tabs: {
                    background-color: #448aff;
                    color: #fff;
                }
            }

            paper-badge {
                --paper-badge-background: rgba(0, 0, 0, 0);
                --paper-badge-text-color: #fff;
            }

            paper-badge[aria-label="0"] {
                visibility: hidden;
            }

            app-toolbar {
                background-color: #448aff;
                color: white;
            }

            app-drawer {
                z-index: 999;
                top: 64px;
                --app-drawer-content-container: {
                    padding: 0px;
                    background-color: #eee;
                }
                ;
            }

            paper-progress {
                width: 100%;
                --paper-progress-active-color: #000;
                --paper-progress-container-color: #fff;
            }

            paper-card {
                margin: 8px;

                --paper-card-actions: {
                    border-top: 1px solid #fafafa;
                }
            }

            anw-single {
                margin: 8px;
            }

            paper-button {
                margin: 8px;
            }

            paper-slider {
                --paper-slider-pin-color: #000;
                --paper-slider-active-color: #000;
                --paper-slider-container-color: #000;
                --paper-slider-knob-color: #000;
                --paper-slider-disabled-active-color: #000;
                --paper-slider-knob-start-border-color: #000;
                --paper-slider-knob-start-color: #000;
                --paper-slider-pin-start-color: #000;
                width: 100%;
            }

            .state[state="0"] {
                color: var(--paper-teal-400);
            }

            .state[state="1"] {
                color: var(--paper-amber-400);
            }

            .state[state="2"] {
                color: var(--paper-red-400);
            }

            iron-icon {
                color: var(--secondary-text-color);
                padding-right: 8px;
            }
        </style>

        <style include="iron-flex iron-flex-alignment"></style>

        <firebase-app auth-domain="anwesenheit-550a6.firebaseapp.com" database-url="https://anwesenheit-550a6.firebaseio.com" api-key="AIzaSyCMOpqIHJ0QG5LddQ-DzCQ7bG6RJaZsKHQ"
            project-id="anwesenheit-550a6" storage-bucket="anwesenheit-550a6.appspot.com" messaging-sender-id="44085346030">
        </firebase-app>

        <firebase-document path="anwesenheiten" data="{{gesamtAnwesenheiten}}"></firebase-document>
        <firebase-document path="anwesenheiten/[[selectedUser]]" data="{{selectedAnwesenheit}}"></firebase-document>
        <firebase-document path="notify/[[selectedUser]]" data="{{secondifies}}"></firebase-document>

        <firebase-query path="notify/[[selectedUser]]" data="{{notifies}}"></firebase-query>

        <firebase-auth id="auth" user="{{user}}" on-error="_errorHandler"></firebase-auth>

        <app-localstorage-document key="selectedUser" data="{{selectedUser}}"></app-localstorage-document>

        <app-header>
            <app-toolbar>
                <div main-title>Anwesenheits Controller</div>
                <paper-icon-button id="btn" icon="inbox" on-tap="_toggleDrawer"></paper-icon-button>
                <paper-badge for="btn" label="[[notifies.length]]"></paper-badge>
                <paper-progress visible="{{gesamtAnwesenheiten.sebastian}}" indeterminate="{{!gesamtAnwesenheiten.sebastian}}" bottom-item></paper-progress>
            </app-toolbar>
        </app-header>

        <app-drawer id="drawer" align="end" swipe-open>
            <anw-notifications on-delete="_delete" notifies={{notifies}}></anw-notificiations>
        </app-drawer>

        <template is="dom-if" if="{{user}}">
            <paper-tabs attr-for-selected="value" selected="{{selectedUser}}" selected="0" scrollable>
                <template is="dom-repeat" items="[[_asArray(gesamtAnwesenheiten)]]">
                    <paper-tab value$="{{item.key}}">{{item.value.name}}</paper-tab>
                </template>
            </paper-tabs>
        </template>

        <div class="layout horizontal center-justified">
            <div class="layout vertical main-content">
                <template is="dom-if" if="{{user}}">
                    <template is="dom-if" if="{{selectedUser}}">

                        <anw-single person={{selectedAnwesenheit}}>
                        </anw-single>

                        <paper-card elevation=3>
                            <div class="card-content">
                                <paper-input id="inputMessage" label="Message" always-float-label></paper-input>
                                <div>Status</div>
                                <paper-radio-group id="inputStatus" selected="{{curVal}}">
                                    <paper-radio-button name="0">Anwesend</paper-radio-button>
                                    <paper-radio-button name="1">Unterwegs</paper-radio-button>
                                    <paper-radio-button name="2">Abwesend</paper-radio-button>
                                </paper-radio-group>
                                <vaadin-date-picker-light class="full-width" attr-for-value="value" i18n=[[i18nObject]]>
                                    <paper-input id="inputUntil" label="Gültig bis (einschließlich)" always-float-label>
                                    </paper-input>
                                </vaadin-date-picker-light>
                            </div>
                            <div class="card-actions">
                                <paper-button class="state" state$="{{curVal}}" on-tap="_saveCustom">Speichern</paper-button>
                            </div>
                        </paper-card>

                        <div class="layout horizontal full-width">
                            <paper-button on-tap="_clickBtn" raised class="state flex" state=0>Anwesend</paper-button>
                            <paper-button on-tap="_clickBtn" raised class="state flex" state=1>Im Haus unterwegs</paper-button>
                            <paper-button on-tap="_clickBtn" raised class="state flex" state=2>abwesend</paper-button>
                        </div>
                    </template>
                </template>

                <template is="dom-if" if="{{!user}}">
                    <paper-button on-tap="_loginGithub" raised>Login Github</paper-button>
                    <paper-button on-tap="_loginGoogle" raised>Login Google</paper-button>
                </template>
            </div>
        </div>

    </template>

    <script>
        /**
     * @customElement
     * @polymer
     */
        class AnwctrlApp extends Polymer.Element {
            static get is() { return 'anwctrl-app'; }
            static get properties() {
                return {
                    lastNObj: Object,
                    gesamtAnwesenheiten: Object,
                    notifies: Array,
                    selectedUser: String,
                    user: Object,
                    i18nObject: {
                        type: Object,
                        value: {
                            monthNames: [
                                'Januar', 'Februar', 'März', 'April', 'Mai',
                                'Juni', 'Juli', 'August', 'September',
                                'Oktober', 'November', 'Dezember'
                            ],
                            weekdays: [
                                'Sonntag', 'Montag', 'Dienstag', 'Mittwoch',
                                'Donnerstag', 'Freitag', 'Samstag'
                            ],
                            weekdaysShort: [
                                'So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'
                            ],
                            firstDayOfWeek: 1,
                            week: 'Woche',
                            calendar: 'Kalender',
                            clear: 'Leeren',
                            today: 'Heute',
                            cancel: 'Abbrechen',
                            formatDate: d => {
                                return ("0" + d.getDate()).slice(-2) + '.' + ("0" + (d.getMonth() + 1)).slice(-2) + '.' + d.getFullYear();
                            },
                            formatTitle: (monthName, fullYear) => {
                                return monthName + ' ' + fullYear;
                            }
                        }
                    }
                };
            }

            _delete(event) {
                this.set('secondifies.' + event.detail, null);
            }

            _loginGithub() {
                this.$.auth.signInWithRedirect("github")
                    .then(function (response) {
                        this._errorHandler(response);
                    })
                    .catch(function (error) {
                        this._errorHandler(error);
                    });
            }

            _loginGoogle() {
                this.$.auth.signInWithRedirect("google")
                    .then(function (response) {
                        this._errorHandler(response);
                    })
                    .catch(function (error) {
                        this._errorHandler(error);
                    });
            }

            _errorHandler(error) {
                console.log(error);
            }

            _saveCustom() {
                let inpmessage = this.shadowRoot.querySelector('#inputMessage');
                let inpstatus = this.shadowRoot.querySelector('#inputStatus');
                let inpuntil = this.shadowRoot.querySelector('#inputUntil');
                this._changeState(inpstatus.selected, inpmessage.value, inpuntil.value);
                inpmessage.value = "";
                inpstatus.value = "";
                inpuntil.value = "";
            }

            _clickBtn(event) {
                var outerHTML = event.target.outerHTML;
                if (outerHTML.includes('state="0"')) {
                    this._changeState(0, "Anwesend", "");
                } else if (outerHTML.includes('state="1"')) {
                    this._changeState(1, "Im Haus unterwegs", "");
                } else if (outerHTML.includes('state="2"')) {
                    this._changeState(2, "Abwesend", "");
                }
            }

            _changeState(newStatus, newMessage, newUntil) {
                this.set('selectedAnwesenheit.status', newStatus);
                this.set('selectedAnwesenheit.message', newMessage);
                this.set('selectedAnwesenheit.until', newUntil);
            }

            _asArray(obj) {
                return Object.keys(obj).map(function (key) {
                    return { key: key, value: obj[key] };
                });
            }

            _toggleDrawer(event) {
                this.$.drawer.toggle();
            }
        }


        window.customElements.define(AnwctrlApp.is, AnwctrlApp);
    </script>
</dom-module>